{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12 text-center mb-5">
            <h1 class="display-4">
                <i class="fas fa-upload me-3"></i>
                Upload Exoplanet Data
            </h1>
            <p class="lead">Upload CSV files with planetary data for batch classification and analysis</p>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Upload Form -->
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-file-csv me-2"></i>
                        Data Upload
                    </h3>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="csvFile" class="form-label">
                                <i class="fas fa-file-upload me-1"></i>CSV File
                            </label>
                            <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                            <div class="form-text">
                                Upload a CSV file containing exoplanet data. Required columns: orbital_period, planetary_radius, stellar_temperature
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modelSelect" class="form-label">
                                    <i class="fas fa-brain me-1"></i>ML Model
                                </label>
                                <select class="form-select" id="modelSelect" name="model_name">
                                    <option value="Final Gradient Boosting">Final Gradient Boosting (86.15% CV Accuracy)</option>
                                    <option value="Final Random Forest">Final Random Forest (84.77% CV Accuracy)</option>
                                    <option value="Final Extra Trees">Final Extra Trees (84.66% CV Accuracy)</option>
                                    <option value="Final Histogram GB">Final Histogram GB (83.45% CV Accuracy)</option>
                                    <option value="Final SVM">Final SVM (74.62% CV Accuracy)</option>
                                    <option value="Final Ensemble">Final Ensemble (85.63% CV Accuracy)</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-info-circle me-1"></i>Processing Options
                                </label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeExplanations" checked>
                                    <label class="form-check-label" for="includeExplanations">
                                        Include AI explanations
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="saveResults" checked>
                                    <label class="form-check-label" for="saveResults">
                                        Save results for download
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-nasa btn-lg">
                                <i class="fas fa-rocket me-2"></i>Process Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Upload Progress -->
            <div class="loading" id="uploadLoading" style="display: none;">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <h5>Processing Your Data...</h5>
                        <p class="text-muted">Analyzing planetary parameters and generating classifications</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Upload Results -->
            <div id="uploadResults" style="display: none;">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Data Format Guide -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Data Format Guide
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Required Columns</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><code>orbital_period</code></span>
                                    <small class="text-muted">Days</small>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><code>planetary_radius</code></span>
                                    <small class="text-muted">Earth radii</small>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><code>stellar_temperature</code></span>
                                    <small class="text-muted">Kelvin</small>
                                </li>
                            </ul>
                            
                            <h5 class="mt-4">Optional Columns</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><code>transit_duration</code> - Hours</li>
                                <li class="list-group-item"><code>stellar_radius</code> - Solar radii</li>
                                <li class="list-group-item"><code>stellar_mass</code> - Solar masses</li>
                                <li class="list-group-item"><code>distance</code> - Parsecs</li>
                                <li class="list-group-item"><code>planetary_mass</code> - Earth masses</li>
                            </ul>
                        </div>
                        
                        <div class="col-md-6">
                            <h5>Example CSV Format</h5>
                            <div class="bg-light p-3 rounded">
                                <pre><code>orbital_period,planetary_radius,stellar_temperature,stellar_radius,stellar_mass
365.25,1.0,5778,1.0,1.0
3.52,14.8,6065,1.18,1.15
1.51,1.09,2516,0.12,0.09
384.8,1.63,5757,1.11,1.04</code></pre>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="downloadTemplate()">
                                    <i class="fas fa-download me-1"></i>Download Template
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-2" onclick="showSampleData()">
                                    <i class="fas fa-eye me-1"></i>View Sample Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sample Data Modal -->
    <div class="modal fade" id="sampleDataModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-database me-2"></i>Sample Exoplanet Data
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Planet</th>
                                    <th>Orbital Period</th>
                                    <th>Planetary Radius</th>
                                    <th>Stellar Temp</th>
                                    <th>Stellar Radius</th>
                                    <th>Stellar Mass</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Kepler-452b</td>
                                    <td>384.8 days</td>
                                    <td>1.63 Earth radii</td>
                                    <td>5757 K</td>
                                    <td>1.11 Solar radii</td>
                                    <td>1.04 Solar masses</td>
                                </tr>
                                <tr>
                                    <td>HD 209458 b</td>
                                    <td>3.52 days</td>
                                    <td>14.8 Earth radii</td>
                                    <td>6065 K</td>
                                    <td>1.18 Solar radii</td>
                                    <td>1.15 Solar masses</td>
                                </tr>
                                <tr>
                                    <td>TRAPPIST-1b</td>
                                    <td>1.51 days</td>
                                    <td>1.09 Earth radii</td>
                                    <td>2516 K</td>
                                    <td>0.12 Solar radii</td>
                                    <td>0.09 Solar masses</td>
                                </tr>
                                <tr>
                                    <td>Proxima Centauri b</td>
                                    <td>11.2 days</td>
                                    <td>1.3 Earth radii</td>
                                    <td>3042 K</td>
                                    <td>0.14 Solar radii</td>
                                    <td>0.12 Solar masses</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-nasa" onclick="downloadSampleCSV()">
                        <i class="fas fa-download me-1"></i>Download Sample CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', handleUpload);
    
    // Drag and drop functionality
    const fileInput = document.getElementById('csvFile');
    const uploadCard = document.querySelector('.card');
    
    uploadCard.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadCard.classList.add('border-primary');
    });
    
    uploadCard.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadCard.classList.remove('border-primary');
    });
    
    uploadCard.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadCard.classList.remove('border-primary');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'text/csv') {
            fileInput.files = files;
        } else {
            showAlert('Please upload a CSV file', 'warning');
        }
    });
});

async function handleUpload(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    // Validate file
    const fileInput = document.getElementById('csvFile');
    if (!fileInput.files[0]) {
        showAlert('Please select a CSV file', 'warning');
        return;
    }
    
    // Show loading
    showLoading('uploadLoading');
    document.getElementById('uploadResults').style.display = 'none';
    
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Upload failed');
        }
        
        const result = await response.json();
        displayUploadResults(result);
        
    } catch (error) {
        showAlert('Upload failed: ' + error.message, 'danger');
    } finally {
        hideLoading('uploadLoading');
    }
}

function displayUploadResults(result) {
    const container = document.getElementById('uploadResults');
    
    // Ensure we have valid data
    if (!result.predictions || !Array.isArray(result.predictions)) {
        showAlert('Invalid response format: predictions array missing', 'danger');
        return;
    }
    
    if (!result.confidence || !Array.isArray(result.confidence)) {
        showAlert('Invalid response format: confidence array missing', 'danger');
        return;
    }
    
    container.innerHTML = `
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>
                    Processing Complete
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Processing Summary</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Total Records:</span>
                                <strong>${result.total_records}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Average Confidence:</span>
                                <strong>${(result.average_confidence * 100).toFixed(1)}%</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Processing Time:</span>
                                <strong>${result.processing_time || 'N/A'}</strong>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Classification Distribution</h5>
                        <div id="classificationChart"></div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <h5>Sample Predictions</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Record</th>
                                        <th>Classification</th>
                                        <th>Confidence</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.predictions.slice(0, 10).map((pred, index) => `
                                        <tr>
                                            <td>#${index + 1}</td>
                                            <td>
                                                <span class="badge ${getBadgeClass(pred)}">
                                                    ${formatPrediction(pred)}
                                                </span>
                                            </td>
                                            <td>${(result.confidence && result.confidence[index] ? (result.confidence[index] * 100).toFixed(1) : 'N/A')}%</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="explainPrediction(${index})">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="${result.download_url}" class="btn btn-nasa btn-lg me-3">
                        <i class="fas fa-download me-2"></i>Download Results
                    </a>
                    <button class="btn btn-outline-primary btn-lg" onclick="uploadAnother()">
                        <i class="fas fa-plus me-2"></i>Upload Another File
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.style.display = 'block';
    
    // Create classification chart
    createClassificationChart(result.predictions);
}

function createClassificationChart(predictions) {
    const counts = predictions.reduce((acc, pred) => {
        acc[pred] = (acc[pred] || 0) + 1;
        return acc;
    }, {});
    
    const data = [{
        values: Object.values(counts),
        labels: Object.keys(counts).map(formatPrediction),
        type: 'pie',
        marker: {
            colors: Object.keys(counts).map(getChartColor)
        }
    }];
    
    const layout = {
        height: 300,
        margin: { t: 0, b: 0, l: 0, r: 0 }
    };
    
    Plotly.newPlot('classificationChart', data, layout);
}

function getBadgeClass(prediction) {
    switch(prediction.toLowerCase()) {
        case 'confirmed': return 'bg-success';
        case 'candidate': return 'bg-warning';
        case 'false_positive': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function getChartColor(prediction) {
    switch(prediction.toLowerCase()) {
        case 'confirmed': return '#28a745';
        case 'candidate': return '#ffc107';
        case 'false_positive': return '#dc3545';
        default: return '#6c757d';
    }
}

function formatPrediction(prediction) {
    switch(prediction.toLowerCase()) {
        case 'confirmed': return 'Confirmed';
        case 'candidate': return 'Candidate';
        case 'false_positive': return 'False Positive';
        default: return prediction;
    }
}

function explainPrediction(index) {
    // This would show detailed explanation for a specific prediction
    showAlert(`Explanation for prediction #${index + 1} would be shown here`, 'info');
}

function uploadAnother() {
    document.getElementById('uploadForm').reset();
    document.getElementById('uploadResults').style.display = 'none';
    document.getElementById('csvFile').focus();
}

function downloadTemplate() {
    const csvContent = `orbital_period,planetary_radius,stellar_temperature,stellar_radius,stellar_mass,distance
365.25,1.0,5778,1.0,1.0,1.3
3.52,14.8,6065,1.18,1.15,47.7
1.51,1.09,2516,0.12,0.09,12.4
384.8,1.63,5757,1.11,1.04,1400`;
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'exoplanet_template.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function showSampleData() {
    const modal = new bootstrap.Modal(document.getElementById('sampleDataModal'));
    modal.show();
}

function downloadSampleCSV() {
    const csvContent = `orbital_period,planetary_radius,stellar_temperature,stellar_radius,stellar_mass,distance
384.8,1.63,5757,1.11,1.04,1400
3.52,14.8,6065,1.18,1.15,47.7
1.51,1.09,2516,0.12,0.09,12.4
11.2,1.3,3042,0.14,0.12,1.3`;
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sample_exoplanet_data.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>

<style>
.border-primary {
    border: 2px dashed #007bff !important;
}

.progress-bar-striped {
    background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
}
</style>
{% endblock %}
