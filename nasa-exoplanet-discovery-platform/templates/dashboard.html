{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12 text-center mb-5">
            <h1 class="display-4">
                <i class="fas fa-chart-line me-3"></i>
                Analytics Dashboard
            </h1>
            <p class="lead">Comprehensive analysis of model performance and exoplanet data insights</p>
        </div>
    </div>
    
    <!-- Model Performance Overview -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-brain me-2"></i>
                        Model Performance Overview
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row" id="modelPerformanceCards">
                        <div class="col-12 text-center">
                            <div class="loading">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading model performance data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="row mb-5">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Classification Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div id="classificationDistributionChart"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Model Accuracy Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <div id="modelAccuracyChart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Feature Importance -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-star me-2"></i>
                        Feature Importance Analysis
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="featureModelSelect" class="form-label">Select Model:</label>
                            <select class="form-select" id="featureModelSelect" onchange="updateFeatureImportance()">
                                <option value="">Loading models...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="featureCountSelect" class="form-label">Number of Features:</label>
                            <select class="form-select" id="featureCountSelect" onchange="updateFeatureImportance()">
                                <option value="10">Top 10</option>
                                <option value="15">Top 15</option>
                                <option value="20">Top 20</option>
                                <option value="all">All Features</option>
                            </select>
                        </div>
                    </div>
                    <div id="featureImportanceChart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hyperparameter Tuning Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Hyperparameter Tuning
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <form id="tuningForm">
                                <div class="mb-3">
                                    <label for="tuningModelSelect" class="form-label">Model to Tune:</label>
                                    <select class="form-select" id="tuningModelSelect" name="model_name">
                                        <option value="XGBoost">XGBoost</option>
                                        <option value="Random Forest">Random Forest</option>
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="maxDepth" class="form-label">Max Depth:</label>
                                        <input type="number" class="form-control" id="maxDepth" name="max_depth" value="7" min="1" max="20">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="nEstimators" class="form-label">N Estimators:</label>
                                        <input type="number" class="form-control" id="nEstimators" name="n_estimators" value="200" min="50" max="1000">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="learningRate" class="form-label">Learning Rate:</label>
                                    <input type="number" class="form-control" id="learningRate" name="learning_rate" value="0.1" step="0.01" min="0.01" max="1.0">
                                </div>
                                
                                <button type="submit" class="btn btn-nasa">
                                    <i class="fas fa-magic me-2"></i>Start Tuning
                                </button>
                            </form>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="tuningResults" style="display: none;">
                                <!-- Tuning results will be displayed here -->
                            </div>
                            
                            <div id="tuningLoading" style="display: none;">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Tuning...</span>
                                    </div>
                                    <p class="mt-2">Optimizing hyperparameters...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Insights -->
    <div class="row mb-5">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-globe me-2"></i>
                        Planetary Radius Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div id="radiusDistributionChart"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Orbital Period Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div id="periodDistributionChart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Model Management -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Model Management
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-nasa" onclick="retrainAllModels()">
                                    <i class="fas fa-sync-alt me-2"></i>Retrain All Models
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" onclick="downloadModelReport()">
                                    <i class="fas fa-download me-2"></i>Download Model Report
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-outline-secondary" onclick="viewModelLogs()">
                                    <i class="fas fa-list me-2"></i>View Model Logs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let modelData = {};
let featureImportanceData = {};

document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    
    // Setup hyperparameter tuning form
    document.getElementById('tuningForm').addEventListener('submit', handleHyperparameterTuning);
});

async function loadDashboardData() {
    try {
        // Load model performance data
        const [performanceData, featureData] = await Promise.all([
            apiCall('/api/model-performance'),
            apiCall('/api/feature-importance')
        ]);
        
        modelData = performanceData.performance;
        featureImportanceData = featureData.feature_importance;
        
        displayModelPerformanceCards();
        createModelAccuracyChart();
        populateFeatureModelSelect();
        updateFeatureImportance();
        createSampleCharts();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showAlert('Failed to load dashboard data', 'danger');
    }
}

function displayModelPerformanceCards() {
    const container = document.getElementById('modelPerformanceCards');
    
    if (!modelData || Object.keys(modelData).length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No model performance data available. Please train models first.
            </div>
        `;
        return;
    }
    
    const cardsHtml = Object.entries(modelData).map(([modelName, metrics]) => `
        <div class="col-md-4 mb-3">
            <div class="metric-card">
                <div class="metric-value">${(metrics.accuracy * 100).toFixed(1)}%</div>
                <div class="metric-label">${modelName}</div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-light" onclick="showModelDetails('${modelName}')">
                        <i class="fas fa-info-circle me-1"></i>Details
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = `
        <div class="row">
            ${cardsHtml}
        </div>
    `;
}

function createModelAccuracyChart() {
    if (!modelData || Object.keys(modelData).length === 0) return;
    
    const models = Object.keys(modelData);
    const accuracies = models.map(model => modelData[model].accuracy * 100);
    
    const data = [{
        x: models,
        y: accuracies,
        type: 'bar',
        marker: {
            color: 'rgba(11, 61, 145, 0.8)'
        }
    }];
    
    const layout = {
        title: 'Model Accuracy Comparison',
        xaxis: { title: 'Model' },
        yaxis: { title: 'Accuracy (%)' },
        margin: { t: 50 }
    };
    
    Plotly.newPlot('modelAccuracyChart', data, layout);
}

function populateFeatureModelSelect() {
    const select = document.getElementById('featureModelSelect');
    
    if (!featureImportanceData || Object.keys(featureImportanceData).length === 0) {
        select.innerHTML = '<option value="">No models available</option>';
        return;
    }
    
    const models = Object.keys(featureImportanceData);
    select.innerHTML = models.map(model => 
        `<option value="${model}">${model}</option>`
    ).join('');
    
    // Select first model by default
    if (models.length > 0) {
        select.value = models[0];
        updateFeatureImportance();
    }
}

function updateFeatureImportance() {
    const modelSelect = document.getElementById('featureModelSelect');
    const countSelect = document.getElementById('featureCountSelect');
    
    if (!modelSelect.value || !featureImportanceData[modelSelect.value]) {
        return;
    }
    
    const importance = featureImportanceData[modelSelect.value];
    const count = countSelect.value === 'all' ? Object.keys(importance).length : parseInt(countSelect.value);
    
    // Sort features by importance
    const sortedFeatures = Object.entries(importance)
        .sort(([,a], [,b]) => b - a)
        .slice(0, count);
    
    const features = sortedFeatures.map(([name]) => name);
    const values = sortedFeatures.map(([, value]) => value);
    
    const data = [{
        x: values,
        y: features,
        type: 'bar',
        orientation: 'h',
        marker: {
            color: 'rgba(252, 61, 33, 0.8)'
        }
    }];
    
    const layout = {
        title: `Feature Importance - ${modelSelect.value}`,
        xaxis: { title: 'Importance Score' },
        yaxis: { title: 'Features' },
        margin: { t: 50 }
    };
    
    Plotly.newPlot('featureImportanceChart', data, layout);
}

function createSampleCharts() {
    // Classification distribution (sample data)
    const classificationData = [{
        values: [45, 35, 20],
        labels: ['Confirmed', 'Candidate', 'False Positive'],
        type: 'pie',
        marker: {
            colors: ['#28a745', '#ffc107', '#dc3545']
        }
    }];
    
    Plotly.newPlot('classificationDistributionChart', classificationData, {
        title: 'Classification Distribution (Sample)',
        margin: { t: 50 }
    });
    
    // Radius distribution (sample data)
    const radiusData = [{
        x: [0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 5.0, 10.0, 15.0],
        y: [50, 200, 150, 100, 80, 60, 120, 80, 40],
        type: 'histogram',
        marker: {
            color: 'rgba(102, 126, 234, 0.8)'
        }
    }];
    
    Plotly.newPlot('radiusDistributionChart', radiusData, {
        title: 'Planetary Radius Distribution',
        xaxis: { title: 'Radius (Earth radii)' },
        yaxis: { title: 'Count' },
        margin: { t: 50 }
    });
    
    // Period distribution (sample data)
    const periodData = [{
        x: [0.5, 1.0, 2.0, 5.0, 10.0, 50.0, 100.0, 500.0],
        y: [80, 120, 150, 200, 100, 80, 60, 40],
        type: 'histogram',
        marker: {
            color: 'rgba(118, 75, 162, 0.8)'
        }
    }];
    
    Plotly.newPlot('periodDistributionChart', periodData, {
        title: 'Orbital Period Distribution',
        xaxis: { title: 'Period (days)' },
        yaxis: { title: 'Count' },
        margin: { t: 50 }
    });
}

async function handleHyperparameterTuning(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    // Show loading
    document.getElementById('tuningLoading').style.display = 'block';
    document.getElementById('tuningResults').style.display = 'none';
    
    try {
        const result = await apiCall('/api/hyperparameter-tuning', {
            method: 'POST',
            body: new URLSearchParams(data)
        });
        
        displayTuningResults(result);
        
    } catch (error) {
        showAlert('Hyperparameter tuning failed: ' + error.message, 'danger');
    } finally {
        document.getElementById('tuningLoading').style.display = 'none';
    }
}

function displayTuningResults(result) {
    const container = document.getElementById('tuningResults');
    
    container.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Tuning Complete!</h6>
            <p class="mb-1"><strong>Best Parameters:</strong></p>
            <ul class="mb-2">
                ${Object.entries(result.best_params).map(([key, value]) => 
                    `<li><code>${key}: ${value}</code></li>`
                ).join('')}
            </ul>
            <p class="mb-1"><strong>Best CV Score:</strong> ${(result.best_score * 100).toFixed(2)}%</p>
            <p class="mb-0"><strong>Test Accuracy:</strong> ${(result.test_accuracy * 100).toFixed(2)}%</p>
        </div>
    `;
    
    container.style.display = 'block';
}

async function retrainAllModels() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Retraining...';
    button.disabled = true;
    
    try {
        const result = await apiCall('/api/retrain', { method: 'GET' });
        showAlert('Models retrained successfully!', 'success');
        loadDashboardData(); // Refresh dashboard
    } catch (error) {
        showAlert('Failed to retrain models: ' + error.message, 'danger');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

function downloadModelReport() {
    // Create a comprehensive model report
    const report = {
        timestamp: new Date().toISOString(),
        models: modelData,
        feature_importance: featureImportanceData,
        summary: {
            total_models: Object.keys(modelData).length,
            best_model: Object.entries(modelData).reduce((a, b) => a[1].accuracy > b[1].accuracy ? a : b)[0],
            avg_accuracy: Object.values(modelData).reduce((sum, model) => sum + model.accuracy, 0) / Object.keys(modelData).length
        }
    };
    
    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `model_report_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showAlert('Model report downloaded successfully!', 'success');
}

function viewModelLogs() {
    showAlert('Model logs feature coming soon!', 'info');
}

function showModelDetails(modelName) {
    const model = modelData[modelName];
    if (!model) return;
    
    const details = `
        <strong>Model:</strong> ${modelName}<br>
        <strong>Accuracy:</strong> ${(model.accuracy * 100).toFixed(2)}%<br>
        <strong>Training Date:</strong> ${new Date().toLocaleDateString()}<br>
        <strong>Parameters:</strong> ${JSON.stringify(model.best_params || {}, null, 2)}
    `;
    
    showAlert(details, 'info');
}
</script>
{% endblock %}

